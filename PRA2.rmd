---
title: 'Tipología y ciclo de vida de los datos'
subtitle: 'PRÁCTICA 2: Limpieza y análisis de datos'
author: "Autores: Raúl Vicente Ferrer y Carmen Lobato Cassinello"
date: "Enero 2022"
output:
  pdf_document:
    highlight: zenburn
    toc: yes
header-includes:
  - \usepackage {hyperref}
  - \hypersetup {colorlinks = true, linkcolor = blue, urlcolor = blue}
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
# https://cran.r-project.org/web/packages/ggplot2/index.html
if (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')
# https://cran.r-project.org/web/packages/dplyr/index.html
if (!require('dplyr')) install.packages('dplyr'); library('dplyr')
```

## 1. Descripción del dataset.

**¿Qué conjunto de datos se ha utilizado?**

Para la realización de esta práctica se ha utilizado el conjunto de entrenamiento de *Titanic: Machine Learning from Disaster* (kaggle), el cual se puede encontrar en la siguiente [URL](https://www.kaggle.com/c/titanic/data). Se ha renombrado como "train_titanic.csv".

El conjunto de datos recoge información sobre los pasajeros a borde del Titanic cuando el buque chocó contra el iceberg:

* PassengerId: contiene el identificador numérico del pasajero.
* Survived [0, 1]: describe si el pasajero sobrevivió o no al hundimiento del buque.
* Pclass [1, 2, 3]: descibe la clase en la que viajaba el pasajero.
* Name: describe el nombre completo del pasajero.
* Sex [male, female]: describe el género del pasajero.
* Age: descibe la edad del pasajero en años.
* SibSp: describe el número de hermanos/as o esposos/as del pasajero a bordo del buque.
* ParCh: descibe el número de padres o hijos del pasajero a bordo del buque.
* Ticket: descibe el número de billete del pasajero.
* Fare: describe el precio del billete que llevaba el pasajero.
* Cabin: describe la cabina en la que viajaba el pasajero.
* Embarked [C, Q, S]: describe el puerto de embarque del pasajero.

Cada uno de los registros se corresponde con un único viajero.

Los datos del dataset son de tipo carácter o numérico, quedando excluidos otros tipos de variables.

**¿Por qué es importante y qué pregunta pretende responder?**

El conjunto tratado resulta relevante porque nos ayuda a comprender mejor el funcionamiento de la sociedad en 1912, permitiéndonos analizar la evolución hasta la época actual y encontrar potenciales puntos de mejora.

Los datos analizados pretenden dar respuesta a varias preguntas; entre ellas:
1. ¿Cómo se relacionan la clase, el género y la edad con la tasa de supervivencia?
2. ¿Cuántas personas viajaban solas? ¿Y con familia? ¿Cómo se relaciona esto con la tasa de supervivencia?
3. ¿Tiene algo que ver el puerto de embarque con la tasa de supervivencia?


## 2. Integración y selección de los datos de interés a analizar.

Como primer paso, realizamos la carga del conjunto a estudiar:

```{r}
titanic_data <- read.csv("./train_titanic.csv", header=T, sep=",", stringsAsFactors = FALSE, fileEncoding = "UTF-8", na.strings=c("NA", ""))
```

Calcularemos ahora las dimensiones del conjunto y analizaremos el tipo de variable correspondiente con cada columna:

```{r}
str(titanic_data)
```

Observamos que el fichero contiene 891 registros, correspondientes a las 12 variables descritas anteriormente (apartado 1):

- Categóricas: Survived, Pclass, Sex, Embarked
- Numéricas discretas: PassengerId, SibSp, ParCh
- Numéricas continuas: Age, Fare
- Texto: Name, Ticket, Cabin

Para el estudio a realizar, no todas las variables serán necesarias. En concreto, las variables que no aportan información global no resultan relevantes, por lo que se eliminan: 
* PassengerId
* Name
* Ticket
* Cabin

```{r}
titanic_data <- select(titanic_data, -PassengerId, -Name, -Ticket, -Cabin)
```

Cambiamos el tipo de variables a Factor donde sea necesario:
 
```{r}
titanic_data$Survived <- as.factor(titanic_data$Survived)
titanic_data$Pclass <- as.factor(titanic_data$Pclass)
titanic_data$Sex <- as.factor(titanic_data$Sex)
titanic_data$Embarked <- as.factor(titanic_data$Embarked)
summary(titanic_data)
```

## 3. Limpieza de los datos.

### 3.1 Elementos vacíos.

Estudiaremos ahora si nuestros datos contienen elementos vacíos:

```{r}
colSums(is.na(titanic_data))
```

Observamos que tenemos elementos vacíos en las columnas "Age" y "Embarked":

- Age: Nos faltan 177 datos de los 891 registros (19,9%). Realizaremos una inferencia en base al resto de variables para asociar una edad.
- Embarked: Nos faltan 2 datos de los 891 registros (0,2%). Evaluaremos si tiene sentido asumir que pertenecen a un determinado grupo (en función del resto de características); si no es posible categorizar a estos pasajeros, eliminaremos los registros.

##### Age

Como primer paso para realizar nuestra inferencia, seleccionamos las variables que resultan de interés a la hora de predecir la edad de los pasajeros: su género, la clase en la que viajaba, y la supervivencia al hundimiento.
Agrupamos los datos por Sex, Pclass y Survived y calculamos la mediana para cada grupo (esta medida es más resistente a outliers que la media):

```{r}
grouped_titanic_data_median <- titanic_data %>% group_by(Sex, Pclass, Survived) %>% summarise(median = median(Age, na.rm = TRUE))
grouped_titanic_data_median
```

Rellenaremos ahora los valores perdidos con la medida que acabamos de calcular:

```{r}
for (sex in c("female", "male")){
  for (class in c("1", "2", "3")){
    for (survived in c("0", "1")){
      titanic_data$Age[titanic_data$Sex == sex & titanic_data$Pclass == class & titanic_data$Survived == survived & is.na(titanic_data$Age)] <- grouped_titanic_data_median$median[grouped_titanic_data_median$Sex == sex & grouped_titanic_data_median$Pclass == class & grouped_titanic_data_median$Survived == survived]
    }
  }
}
```

##### Embarked

Observamos las características de los dos pasajeros cuyo puerto de embarque desconocemos:

```{r}
titanic_data[is.na(titanic_data$Embarked),]
```

Vemos que ambas pasajeras eran mujeres de primera clase que viajaban solas y sobrevivieron al accidente. Observamos la distribución de puertos en pasajeras con las mismas características:

```{r}
barplot(table(titanic_data$Embarked[titanic_data$Sex == "female" & titanic_data$Pclass == "1" & titanic_data$Survived == "1" & titanic_data$SibSp == "0" & titanic_data$Parch == "0"]))
```
Observamos que hay una proporción similar de pasajeras con estas características que embarcaron en Cherbourg y en Southampton. Como no podemos inferir en qué puerto embarcaron nuestras pasajeras, eliminaremos los dos registros:

```{r}
titanic_data <- titanic_data[!is.na(titanic_data$Embarked),]
```

Comprobamos que no haya ningún valor vacío en el conjunto modificado:

```{r}
colSums(is.na(titanic_data))
```

### 3.2 Identificación y tratamiento de valores extremos.

Realizaremos un análisis de las variables numéricas continuas para detectar posibles valores extremos:

##### Age
```{r}
boxplot(titanic_data$Age)
```

No se observa ningún valor atípico, todos los pasajeros tienen edades por debajo de 80 años.

##### Fare

```{r}
ggplot(titanic_data, aes(x=Pclass, y=Fare)) + geom_boxplot()
```

Observamos diferentes outliers en función de la clase. Vamos a estudiarlas por separado:

- Primera clase
```{r}
first_class <- titanic_data[titanic_data$Pclass == "1" & titanic_data$Fare > 200,]
first_class[order(first_class$Fare),]
```

- Segunda clase
```{r}
second_class <- titanic_data[titanic_data$Pclass == "2" & titanic_data$Fare > 50,]
second_class[order(second_class$Fare),]
```

- Tercera clase
```{r}
third_class <- titanic_data[titanic_data$Pclass == "3" & titanic_data$Fare > 25,]
third_class[order(third_class$Fare),]
```

En todas las clases observamos que los rangos de precios se corresponden con el mismo puerto de embarque. Como consecuencia de esta consistencia en los precios, entendemos que son correctos.


Adicionalmente, analizaremos el histograma de las variables numéricas discretas para detectar posibles valores extremos:

##### SibSp
```{r}
hist(titanic_data$SibSp)
```

Observamos que la mayoría de pasajeros viajan solos o con un número de acompañantes entre 1 y 4. Estudiaremos aquellos pasajeros que viajan con más acompañantes.

```{r}
companions <- titanic_data[titanic_data$SibSp > 4,]
companions[order(third_class$SibSp),]
```

##### Parch
```{r}
hist(titanic_data$Parch)
```

## 4. Análisis de los datos.

### 4.1 Selección de los grupos de datos que se quieren analizar/comparar (planificación de los análisis a aplicar).

### 4.2 Comprobación de la normalidad y homogeneidad de la varianza.

### 4.3 Aplicación de pruebas estadísticas para comparar los grupos de datos. En función de los datos y el objetivo del estudio, aplicar pruebas de contraste de hipótesis, correlaciones, regresiones, etc. Aplicar al menos tres métodos de análisis diferentes.


## 5. Representación de los resultados a partir de tablas y gráficas.



## 6. Resolución del problema. A partir de los resultados obtenidos, ¿cuáles son las conclusiones? ¿Los resultados permiten responder al problema?



## 7. Código.

El código utilizado para el análisis de la información se puede encontrar en la siguiente [URL](https://github.com/clobatoc21/TitanicSurvivalAnalyzer).


## Agradecimientos.

Los datos utilizados han sido recolectados del repositorio [Kaggle](https://www.kaggle.com/c/titanic/overview).

Por este motivo, ellos son los propietarios de los datos utilizados en esta práctica.


## Licencia.

Estos datos están sometidos a la licencia **Released Under CC BY-NC-SA 4.0 License**, la cual ofrece libertades a los usuarios a la par que derechos a los propietarios. Se permite su distribución, se reconoce al autor de la obra y se permite editar el código fuente. No obstante, no se permite lucrarse económicamente con el mismo ni privatizar el software con una licencia que altere las libertades anteriormente expuestas. El propietario de los datos será siempre Kaggle, y así deberá hacerse saber en cualquier utilización de los mismos.


## Tabla contribuciones

**Contribuciones** |**Firma** |
----------------------| ----------------------|
*Investigación Previa* | Carmen Lobato Cassinello, Raúl Vicente Ferrer |
*Redacción de las respuestas* | Carmen Lobato Cassinello, Raúl Vicente Ferrer |
*Desarrollo del código* | Carmen Lobato Cassinello, Raúl Vicente Ferrer 